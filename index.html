<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PlayerPack Composer</title>
<style>
  :root{--bg:#0b0f14;--panel:#141a22;--muted:#5e6a79;--text:#e9eef5;--brand:#31c48d;--brand2:#38bdf8}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1200px;margin:0 auto;padding:20px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:16px}
  h1{font-size:20px;margin:0}
  .grid{display:grid;gap:16px}
  @media(min-width:980px){.layout{grid-template-columns:2fr 1fr}}
  .panel{background:var(--panel);border:1px solid #1e2733;border-radius:16px;padding:16px}
  .row{display:grid;gap:8px;margin-bottom:12px}
  label{font-size:12px;color:var(--muted)}
  input[type="text"],input[type="url"],select{background:#0f141b;border:1px solid #1c2532;color:var(--text);border-radius:10px;padding:10px;outline:none}
  input[type="color"]{width:100%;height:38px;border-radius:10px;border:1px solid #1c2532;background:#0f141b}
  input[type="file"]{font-size:12px}
  .btn{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--brand);color:#07240f}
  .btn.alt{background:var(--brand2);color:#06202a}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .hint{font-size:12px;color:var(--muted)}
  canvas{width:100%;background:black;border-radius:16px;display:block}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .imgbox{border:1px dashed #2a3545;border-radius:12px;padding:12px}
  .error{color:#ff7b7b;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>PlayerPack Composer</h1>
    <div class="hint">Client‑side · Share the link to your team</div>
  </header>

  <div class="grid layout">
    <section class="panel">
      <canvas id="cv" width="1600" height="900"></canvas>
      <div class="hint" id="sizeHint" style="margin-top:6px">Canvas: 1600×900px</div>
    </section>

    <aside class="panel">
      <div class="row">
        <label>Tên gói (name)</label>
        <input id="name" type="text" value="SUM125TOTS2" placeholder="SUM125TOTS2" />
      </div>
      <div class="row two">
        <div>
          <label>Kích thước (WxH)</label>
          <input id="size" type="text" value="1600x900" placeholder="1600x900" />
        </div>
        <div>
          <label>Màu nền</label>
          <input id="bg" type="color" value="#002c5c" />
        </div>
      </div>
      <div class="row two">
        <label><input id="grad" type="checkbox" checked /> Gradient</label>
        <label><input id="tilt" type="checkbox" checked /> Tilt</label>
      </div>
      <div class="row">
        <label>Vị trí tiêu đề</label>
        <select id="titlePos">
          <option value="top">Top</option>
          <option value="bottom" selected>Bottom</option>
          <option value="off">Off</option>
        </select>
      </div>
      <div class="row">
        <label>Ảnh trung tâm</label>
        <select id="centerIdx">
          <option value="0">Ảnh 1</option>
          <option value="1" selected>Ảnh 2</option>
          <option value="2">Ảnh 3</option>
        </select>
      </div>

      <div class="imgbox">
        <div class="row"><strong>Ảnh 1</strong>
          <input id="url0" type="url" placeholder="Dán URL ảnh PNG…"
            value="https://cdn.vn.garenanow.com//fo3vn/project/playerPack/500253240.png" />
          <input id="file0" type="file" accept="image/*" />
        </div>
        <div class="row"><strong>Ảnh 2</strong>
          <input id="url1" type="url" placeholder="Dán URL ảnh PNG…"
            value="https://cdn.vn.garenanow.com//fo3vn/project/playerPack/500229788.png" />
          <input id="file1" type="file" accept="image/*" />
        </div>
        <div class="row"><strong>Ảnh 3</strong>
          <input id="url2" type="url" placeholder="Dán URL ảnh PNG…"
            value="https://cdn.vn.garenanow.com//fo3vn/project/playerPack/500230971.png" />
          <input id="file2" type="file" accept="image/*" />
        </div>
        <div class="hint">Tip: Nếu URL bị chặn CORS, hãy dùng nút chọn file.</div>
      </div>

      <div class="row" id="err" style="display:none"><div class="error"></div></div>

      <div class="row two">
        <button id="render" class="btn primary">Render preview</button>
        <button id="download" class="btn alt">Tải PNG</button>
      </div>
    </aside>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const cv = $("cv"), ctx = cv.getContext("2d");
  const nameEl=$("name"), sizeEl=$("size"), bgEl=$("bg"), gradEl=$("grad"), tiltEl=$("tilt"), titlePosEl=$("titlePos"), centerIdxEl=$("centerIdx");
  const sizeHint=$("sizeHint"), errBox=$("err").firstElementChild;
  const urlEls=[$("url0"),$("url1"),$("url2")];
  const fileEls=[$("file0"),$("file1"),$("file2")];

  function parseSize(s){
    try{const [w,h]=s.toLowerCase().split("x").map(x=>parseInt(x,10));return [Math.max(100,w||1600),Math.max(100,h||900)];}
    catch(e){return [1600,900];}
  }
  function setCanvasSize(){
    const [W,H]=parseSize(sizeEl.value||"1600x900");
    cv.width=W; cv.height=H; sizeHint.textContent=`Canvas: ${W}×${H}px`;
    return [W,H];
  }

  function drawTextWithStroke(text,x,y,fs){
    ctx.save();
    ctx.font=`bold ${fs}px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial`;
    ctx.lineJoin="round"; ctx.miterLimit=2; ctx.strokeStyle="rgba(0,0,0,0.8)"; ctx.lineWidth=Math.max(2,Math.round(fs*0.07)); ctx.fillStyle="#fff";
    ctx.strokeText(text,x,y); ctx.fillText(text,x,y); ctx.restore();
  }
  function gradientBackground(W,H,base){
    ctx.fillStyle=base; ctx.fillRect(0,0,W,H);
    if(!gradEl.checked) return;
    const g=ctx.createRadialGradient(W/2,H/2,Math.min(W,H)*0.2,W/2,H/2,Math.max(W,H)*0.9);
    g.addColorStop(0,'rgba(0,0,0,0)'); g.addColorStop(1,'rgba(0,0,0,0.7)');
    ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  }
  function drawGlowBars(W,H,margin){
    const barH=Math.max(8,Math.floor(H/140));
    ctx.save(); ctx.filter='blur(10px)';
    for(let i=0;i<6;i++){const y=Math.floor(H*0.35+i*barH*2.6); const a=Math.max(0,140-i*18)/255; ctx.fillStyle=`rgba(255,255,255,${a})`; ctx.fillRect(margin,y,W-margin*2,barH);} 
    ctx.restore();
  }
  function fitHeight(img,targetH){
    const ratio=targetH/img.height; const w=Math.max(1, Math.floor(img.width*ratio));
    const c=document.createElement('canvas'); c.width=w; c.height=targetH; const c2=c.getContext('2d'); c2.imageSmoothingQuality='high'; c2.drawImage(img,0,0,w,targetH);
    const out=new Image(); out.src=c.toDataURL('image/png'); return out;
  }
  function loadImage(src){
    return new Promise((res,rej)=>{const im=new Image(); im.crossOrigin='anonymous'; im.onload=()=>res(im); im.onerror=()=>rej(new Error('Không thể tải ảnh: '+src)); im.src=src;});
  }
  function fileToURL(f){return URL.createObjectURL(f)}
  function showErr(msg){const box=document.getElementById('err'); box.style.display='block'; errBox.textContent=msg}
  function clearErr(){document.getElementById('err').style.display='none'; errBox.textContent=''}

  async function render(){
    clearErr();
    const [W,H]=setCanvasSize();
    gradientBackground(W,H,bgEl.value||'#002c5c');

    const margin=Math.floor(Math.min(W,H)*0.06);
    const titleArea=(titlePosEl.value==='off')?0:Math.floor(H*0.18);
    const centerH=Math.floor(H*0.7);
    const playH=Math.min(centerH-margin, Math.floor(H*0.78));

    // resolve sources (file preferred)
    const srcs = await Promise.all([0,1,2].map(async i=>{
      const f=fileEls[i].files && fileEls[i].files[0];
      if(f) return fileToURL(f);
      const u=(urlEls[i].value||'').trim(); if(!u) throw new Error('Thiếu ảnh '+(i+1));
      return u;
    }));

    try{
      const loaded = await Promise.all(srcs.map(loadImage));
      const cIdx=parseInt(centerIdxEl.value,10)||1;
      const order=[0,1,2].filter(i=>i!==cIdx);
      const L=loaded[order[0]], C=loaded[cIdx], R=loaded[order[1]];
      const mainH=Math.floor(playH*0.92), sideH=Math.floor(playH*0.82);
      const Lr=fitHeight(L,sideH), Cr=fitHeight(C,mainH), Rr=fitHeight(R,sideH);

      const lt = (document.getElementById('tilt').checked? -7:0);
      const rt = (document.getElementById('tilt').checked? 7:0);
      const spacing=Math.floor(W*0.02);
      const totalW=Lr.width+Cr.width+Rr.width+2*spacing;
      const startX=Math.floor((W-totalW)/2);
      const yBase=Math.floor((H-titleArea-Math.max(Lr.height,Cr.height,Rr.height))/2);

      drawGlowBars(W,H,margin);

      function drawWithTilt(img,x,y,deg){
        const rad=deg*Math.PI/180; ctx.save(); ctx.translate(x+img.width/2,y+img.height/2); ctx.rotate(rad); ctx.translate(-img.width/2,-img.height/2); ctx.drawImage(img,0,0); ctx.restore();
      }
      function drawShadow(img,x,y,opt={}){
        const {blur=35, offsetY=25, scale=1.05, opacity=0.75}=opt;
        const sw=Math.floor(img.width*scale), sh=Math.floor(img.height*scale);
        const sx=x-Math.floor((sw-img.width)/2), sy=y-Math.floor((sh-img.height)/2)+offsetY;
        ctx.save(); ctx.globalAlpha=opacity; ctx.filter=`blur(${blur}px)`; ctx.drawImage(img,sx,sy,sw,sh); ctx.restore();
      }

      const lx=startX, ly=yBase, cx=startX+Lr.width+spacing, cy=yBase-Math.floor(H*0.02), rx=cx+Cr.width+spacing, ry=yBase;

      ctx.save(); ctx.translate(lx+Lr.width/2,ly+Lr.height/2); ctx.rotate(lt*Math.PI/180); ctx.translate(-Lr.width/2,-Lr.height/2); drawShadow(Lr,0,0,{blur:35,offsetY:25,scale:1.05,opacity:.75}); ctx.restore();
      drawShadow(Cr,cx,cy,{blur:40,offsetY:28,scale:1.06,opacity:.78});
      ctx.save(); ctx.translate(rx+Rr.width/2,ry+Rr.height/2); ctx.rotate(rt*Math.PI/180); ctx.translate(-Rr.width/2,-Rr.height/2); drawShadow(Rr,0,0,{blur:35,offsetY:25,scale:1.05,opacity:.75}); ctx.restore();

      drawWithTilt(Lr,lx,ly,lt);
      ctx.drawImage(Cr,cx,cy);
      drawWithTilt(Rr,rx,ry,rt);

      const title = (nameEl.value||"").trim();
      if(title && titlePosEl.value!=='off'){
        const maxW=W-margin*2; let fs=120; ctx.save();
        while(fs>24){ ctx.font=`bold ${fs}px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial`; if(ctx.measureText(title).width<=maxW) break; fs-=2; }
        ctx.restore(); const textY = (titlePosEl.value==='top') ? (margin+fs) : (H - margin);
        drawTextWithStroke(title, margin, textY, fs);
      }

    }catch(e){ document.getElementById('err').style.display='block'; errBox.textContent=e.message||String(e); throw e; }
  }

  document.getElementById("render").addEventListener('click', render);
  document.getElementById("download").addEventListener('click', ()=>{
    const a=document.createElement('a'); a.href=cv.toDataURL('image/png'); a.download=(nameEl.value||'playerpack')+'.png'; a.click();
  });

  render();
})();
</script>
</body>
</html>
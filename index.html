<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>3 Cards – Same Size (Transparent)</title>
<style>
  :root{--bg:#0b0f14;--panel:#141a22;--muted:#5e6a79;--text:#e9eef5;--brand:#31c48d;--brand2:#38bdf8}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:20px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  h1{font-size:18px;margin:0}
  .grid{display:grid;gap:16px}
  @media(min-width:980px){.layout{grid-template-columns:2fr 1fr}}
  .panel{background:#141a22;border:1px solid #1e2733;border-radius:16px;padding:16px}
  .row{display:grid;gap:8px;margin-bottom:12px}
  label{font-size:12px;color:var(--muted)}
  input[type="text"],input[type="url"]{background:#0f141b;border:1px solid #1c2532;color:var(--text);border-radius:10px;padding:10px;outline:none}
  input[type="file"]{font-size:12px}
  .btn{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--brand);color:#07240f}
  .btn.alt{background:var(--brand2);color:#06202a}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .hint{font-size:12px;color:var(--muted)}
  /* checker chỉ để xem nền trong suốt (không xuất ra PNG) */
  .checker{border-radius:16px; overflow:hidden; position:relative}
  .checker::before{
    content:""; display:block; width:100%; height:100%;
    background:
      linear-gradient(45deg, #dde3ea 25%, transparent 25%) 0 0/20px 20px,
      linear-gradient(45deg, transparent 75%, #dde3ea 75%) 0 0/20px 20px,
      linear-gradient(45deg, #dde3ea 25%, transparent 25%) 10px 10px/20px 20px,
      linear-gradient(45deg, transparent 75%, #dde3ea 75%) 10px 10px/20px 20px;
    position:absolute; inset:0; z-index:0; opacity:.6;
  }
  canvas{position:relative; z-index:1; width:100%; background:transparent; display:block}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>3 Cards — bằng nhau, nền trong suốt</h1>
    <div class="hint">Chồng lớp: 3 dưới → 2 giữa → 1 trên</div>
  </header>

  <div class="grid layout">
    <section class="panel">
      <div class="checker">
        <canvas id="cv" width="1000" height="800"></canvas>
      </div>
      <div class="hint" id="sizeHint" style="margin-top:6px">Canvas: 1000×800px</div>
    </section>

    <aside class="panel">
      <div class="row">
        <label>Tên file tải xuống</label>
        <input id="name" type="text" value="SUM125TOTS2" />
      </div>
      <div class="row">
        <label>Kích thước (WxH) — gợi ý 1000x800</label>
        <input id="size" type="text" value="1000x800" />
      </div>

      <div class="row">
        <strong>Ảnh 1 (trái) — TRÊN CÙNG</strong>
        <input id="url0" type="url" placeholder="Dán URL PNG/JPG (khuyên dùng Choose File)">
        <input id="file0" type="file" accept="image/*" />
      </div>
      <div class="row">
        <strong>Ảnh 2 (giữa)</strong>
        <input id="url1" type="url" placeholder="URL PNG/JPG">
        <input id="file1" type="file" accept="image/*" />
      </div>
      <div class="row">
        <strong>Ảnh 3 (phải) — DƯỚI CÙNG</strong>
        <input id="url2" type="url" placeholder="URL PNG/JPG">
        <input id="file2" type="file" accept="image/*" />
      </div>

      <div class="hint">Tip: Dùng **Choose File** cho cả 3 ảnh để render & tải PNG chắc chắn (tránh CORS).</div>

      <div class="row" id="err" style="display:none"><div class="hint" style="color:#ff7b7b"></div></div>

      <div class="row" style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <button id="render" class="btn primary">Render preview</button>
        <button id="download" class="btn alt">Tải PNG</button>
      </div>
    </aside>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const cv = $("cv"), ctx = cv.getContext("2d");
  const nameEl=$("name"), sizeEl=$("size"), sizeHint=$("sizeHint");
  const urlEls=[$("url0"),$("url1"),$("url2")];
  const fileEls=[$("file0"),$("file1"),$("file2")];
  const errWrap=$("err");
  let canDownload = true;

  // --- Cấu hình: cả 3 ảnh cùng chiều cao ---
  const CONFIG = {
    cardH: 0.90,     // chiều cao mỗi ảnh so với canvas (90%)
    overlap: 0.36,   // chồng lên theo % bề ngang ảnh giữa
    yOffset: 0.00    // dịch dọc (0 = cùng cao)
  };

  function showErr(msg){ errWrap.style.display="block"; errWrap.firstElementChild.textContent=msg; }
  function clearErr(){ errWrap.style.display="none"; errWrap.firstElementChild.textContent=""; }

  function parseSize(s){ try{const [w,h]=s.toLowerCase().split("x").map(x=>parseInt(x,10));return [Math.max(200,w||1000),Math.max(200,h||800)];}catch(e){return [1000,800];} }
  function setCanvasSize(){
    const [W,H]=parseSize(sizeEl.value||"1000x800");
    cv.width=W; cv.height=H; sizeHint.textContent=`Canvas: ${W}×${H}px`;
    return [W,H];
  }

  // FileReader → dataURL (tránh CORS)
  function readFileAsDataURL(file){
    return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=()=>rej(new Error("Không đọc được file: "+(file?.name||""))); fr.readAsDataURL(file); });
  }
  function loadImage(src){
    return new Promise((res,rej)=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=()=>rej(new Error("Không tải được ảnh")); im.src=src; });
  }
  // URL với fallback: nếu CORS fail, vẫn preview (không cho download)
  function loadURLWithCorsFallback(src){
    return new Promise((resolve,reject)=>{
      const ok=(img,corsOK)=>resolve({img,corsOK});
      const a=new Image(); a.crossOrigin="anonymous";
      a.onload=()=>ok(a,true);
      a.onerror=()=>{ const b=new Image(); b.onload=()=>ok(b,false); b.onerror=()=>reject(new Error("Không tải được URL: "+src)); b.src=src; };
      a.src=src;
    });
  }

  function sizeToHeight(img, h){ const r=h/img.height; return {w:Math.round(img.width*r), h:Math.round(h)}; }

  async function render(){
    clearErr(); canDownload = true;
    const [W,H]=setCanvasSize();
    ctx.clearRect(0,0,W,H); // nền trong suốt

    // Nguồn ảnh: ưu tiên file
    const sources = await Promise.all([0,1,2].map(async i=>{
      const f = fileEls[i].files?.[0];
      if (f) return { type:"file", src: await readFileAsDataURL(f) };
      const u = (urlEls[i].value||"").trim();
      if (!u) throw new Error("Thiếu ảnh "+(i+1));
      return { type:"url", src:u };
    }));

    try{
      const loaded = await Promise.all(sources.map(async s=>{
        if (s.type==="file") return {img: await loadImage(s.src), corsOK:true};
        const r = await loadURLWithCorsFallback(s.src);
        if (!r.corsOK) canDownload=false;
        return r;
      }));

      // L = Ảnh 1 (trên cùng), C = Ảnh 2 (giữa), R = Ảnh 3 (dưới cùng)
      const L = loaded[0].img, C = loaded[1].img, R = loaded[2].img;

      // Cùng chiều cao cho cả 3 ảnh
      const hAll = Math.floor(H * CONFIG.cardH);
      const S1 = sizeToHeight(L, hAll);
      const S2 = sizeToHeight(C, hAll);
      const S3 = sizeToHeight(R, hAll);

      // Tính vị trí & overlap theo bề rộng ảnh giữa
      const overlap = Math.floor(S2.w * CONFIG.overlap);
      const cx = Math.floor((W - S2.w)/2);
      const cy = Math.floor((H - S2.h)/2);
      const yOff = Math.floor(H * CONFIG.yOffset);

      const lx = cx - S1.w + overlap;
      const ly = cy + yOff;
      const rx = cx + S2.w - overlap;
      const ry = cy + yOff;

      // Vẽ theo lớp: 3 (dưới) → 2 (giữa) → 1 (trên)
      ctx.drawImage(R, rx, ry, S3.w, S3.h);
      ctx.drawImage(C, cx, cy, S2.w, S2.h);
      ctx.drawImage(L, lx, ly, S1.w, S1.h);

      if (!canDownload){
        showErr("Dùng URL chặn CORS: vẫn preview được nhưng không thể 'Tải PNG'. Hãy dùng 'Choose File' hoặc host ảnh cùng domain.");
      }

    }catch(e){
      showErr(e.message||String(e));
      console.error(e);
    }
  }

  $("render").addEventListener("click", render);
  $("download").addEventListener("click", ()=>{
    if (!canDownload){
      showErr("Không thể tải PNG vì ảnh URL chặn CORS. Dùng 'Choose File' cho cả 3 ảnh hoặc host cùng domain.");
      return;
    }
    const a=document.createElement("a");
    a.href=cv.toDataURL("image/png");
    let fn=(($("name").value||"playerpack").trim()||"playerpack").replace(/[/\\?%*:|"<>]+/g,"-");
    a.download=fn+".png";
    a.click();
  });

  render();
})();
</script>
</body>
</html>

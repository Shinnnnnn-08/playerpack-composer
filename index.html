<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PlayerPack Composer</title>
<style>
  :root{--bg:#0b0f14;--panel:#141a22;--muted:#5e6a79;--text:#e9eef5;--brand:#31c48d;--brand2:#38bdf8}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1200px;margin:0 auto;padding:20px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:16px}
  h1{font-size:20px;margin:0}
  .grid{display:grid;gap:16px}
  @media(min-width:980px){.layout{grid-template-columns:2fr 1fr}}
  .panel{background:var(--panel);border:1px solid #1e2733;border-radius:16px;padding:16px}
  .row{display:grid;gap:8px;margin-bottom:12px}
  label{font-size:12px;color:var(--muted)}
  input[type="text"],input[type="url"],select{background:#0f141b;border:1px solid #1c2532;color:var(--text);border-radius:10px;padding:10px;outline:none}
  input[type="file"]{font-size:12px}
  .btn{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:var(--brand);color:#07240f}
  .btn.alt{background:var(--brand2);color:#06202a}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .hint{font-size:12px;color:var(--muted)}
  /* Canvas trong suốt; hộp caro chỉ để preview transparency */
  .checker{border-radius:16px; overflow:hidden}
  .checker::before{
    content:""; display:block; width:100%; height:100%;
    background:
      linear-gradient(45deg, #dde3ea 25%, transparent 25%) 0 0/20px 20px,
      linear-gradient(45deg, transparent 75%, #dde3ea 75%) 0 0/20px 20px,
      linear-gradient(45deg, #dde3ea 25%, transparent 25%) 10px 10px/20px 20px,
      linear-gradient(45deg, transparent 75%, #dde3ea 75%) 10px 10px/20px 20px;
    position:absolute; inset:0; z-index:0; opacity:.6;
  }
  .checker-wrap{position:relative}
  canvas{position:relative; z-index:1; width:100%; background:transparent; display:block}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .imgbox{border:1px dashed #2a3545;border-radius:12px;padding:12px}
  .error{color:#ff7b7b;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>PlayerPack Composer</h1>
    <div class="hint">PNG nền trong suốt · Share link cho team</div>
  </header>

  <div class="grid layout">
    <section class="panel">
      <div class="checker checker-wrap">
        <canvas id="cv" width="1600" height="900"></canvas>
      </div>
      <div class="hint" id="sizeHint" style="margin-top:6px">Canvas: 1600×900px</div>
    </section>

    <aside class="panel">
      <div class="row">
        <label>Tên file tải xuống (không vẽ lên ảnh)</label>
        <input id="name" type="text" value="SUM125TOTS2" placeholder="SUM125TOTS2" />
      </div>
      <div class="row">
        <label>Kích thước (WxH)</label>
        <input id="size" type="text" value="1600x900" placeholder="1600x900" />
      </div>
      <div class="row two">
        <label><input id="tilt" type="checkbox" checked /> Tilt hai ảnh bên</label>
        <label><input id="shadow" type="checkbox" checked /> Bóng đổ</label>
      </div>
      <div class="row">
        <label>Ảnh trung tâm</label>
        <select id="centerIdx">
          <option value="0">Ảnh 1</option>
          <option value="1" selected>Ảnh 2</option>
          <option value="2">Ảnh 3</option>
        </select>
      </div>

      <div class="imgbox">
        <div class="row"><strong>Ảnh 1</strong>
          <input id="url0" type="url" placeholder="Dán URL PNG (nền trong suốt càng đẹp)"
            value="https://cdn.vn.garenanow.com//fo3vn/project/playerPack/500253240.png" />
          <input id="file0" type="file" accept="image/*" />
        </div>
        <div class="row"><strong>Ảnh 2</strong>
          <input id="url1" type="url" placeholder="Dán URL PNG (nền trong suốt càng đẹp)"
            value="https://cdn.vn.garenanow.com//fo3vn/project/playerPack/500229788.png" />
          <input id="file1" type="file" accept="image/*" />
        </div>
        <div class="row"><strong>Ảnh 3</strong>
          <input id="url2" type="url" placeholder="Dán URL PNG (nền trong suốt càng đẹp)"
            value="https://cdn.vn.garenanow.com//fo3vn/project/playerPack/500230971.png" />
          <input id="file2" type="file" accept="image/*" />
        </div>
        <div class="hint">Nếu URL bị chặn CORS, hãy dùng nút chọn file.</div>
      </div>

      <div class="row" id="err" style="display:none"><div class="error"></div></div>

      <div class="row two">
        <button id="render" class="btn primary">Render preview</button>
        <button id="download" class="btn alt">Tải PNG</button>
      </div>
    </aside>
  </div>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const cv = $("cv"), ctx = cv.getContext("2d");
  const nameEl=$("name"), sizeEl=$("size"), tiltEl=$("tilt"), shadowEl=$("shadow"), centerIdxEl=$("centerIdx");
  const sizeHint=$("sizeHint");
  const urlEls=[$("url0"),$("url1"),$("url2")];
  const fileEls=[$("file0"),$("file1"),$("file2")];

  let canDownload = true; // có ảnh bị CORS -> false

  // Ô lỗi an toàn (nếu thiếu vẫn không crash)
  function showErr(msg){
    let wrap = document.getElementById("err");
    if (!wrap) return alert(msg);
    wrap.style.display = "block";
    let box = wrap.querySelector(".error");
    if (!box){
      box = document.createElement("div"); box.className = "error"; wrap.appendChild(box);
    }
    box.textContent = msg;
  }
  function clearErr(){
    const wrap = document.getElementById("err");
    if (wrap){ wrap.style.display = "none"; const box = wrap.querySelector(".error"); if (box) box.textContent=""; }
  }

  function parseSize(s){
    try{const [w,h]=s.toLowerCase().split("x").map(x=>parseInt(x,10));return [Math.max(100,w||1600),Math.max(100,h||900)];}
    catch(e){return [1600,900];}
  }
  function setCanvasSize(){
    const [W,H]=parseSize(sizeEl.value||"1600x900");
    cv.width=W; cv.height=H; sizeHint.textContent=`Canvas: ${W}×${H}px`;
    return [W,H];
  }

  // ĐỌC FILE đảm bảo (data URL) ⇒ luôn chạy, không dính CORS
  function readFileAsDataURL(file){
    return new Promise((resolve,reject)=>{
      const fr = new FileReader();
      fr.onload = ()=> resolve(fr.result);
      fr.onerror = ()=> reject(new Error("Không đọc được file: " + (file?.name||"")));
      fr.readAsDataURL(file);
    });
  }

  // Tải ảnh URL với fallback: nếu CORS fail, vẫn preview (không cho download)
  function loadURLWithCorsFallback(src){
    return new Promise((resolve,reject)=>{
      const ok = (img, corsOK)=>resolve({img, corsOK});
      const i1 = new Image();
      i1.crossOrigin = "anonymous";
      i1.onload = ()=> ok(i1, true);
      i1.onerror = ()=>{
        const i2 = new Image();
        i2.onload = ()=> ok(i2, false);
        i2.onerror = ()=> reject(new Error("Không thể tải ảnh: "+src));
        i2.src = src;
      };
      i1.src = src;
    });
  }

  // Tạo HTMLImage từ dataURL/blobURL
  function loadImage(src){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      img.onload = ()=> resolve(img);
      img.onerror = ()=> reject(new Error("Không thể hiển thị ảnh đã chọn."));
      img.src = src;
    });
  }

  // scale theo chiều cao → chỉ trả về kích thước, không tạo canvas phụ (tránh taint)
  function sizeToHeight(img, targetH){
    const ratio = targetH / img.height;
    return { w: Math.max(1, Math.floor(img.width * ratio)), h: targetH };
  }

  function drawWithTilt(img, x, y, deg, w, h){
    const rad = deg * Math.PI / 180;
    ctx.save();
    ctx.translate(x + w/2, y + h/2);
    ctx.rotate(rad);
    ctx.translate(-w/2, -h/2);
    ctx.drawImage(img, 0, 0, w, h);
    ctx.restore();
  }
  function drawShadow(img, x, y, w, h, opt={}){
    const {blur=35, offsetY=25, scale=1.05, opacity=0.75} = opt;
    const sw = Math.floor(w * scale), sh = Math.floor(h * scale);
    const sx = x - Math.floor((sw - w)/2), sy = y - Math.floor((sh - h)/2) + offsetY;
    ctx.save();
    ctx.globalAlpha = opacity;
    ctx.filter = `blur(${blur}px)`;
    ctx.drawImage(img, sx, sy, sw, sh);
    ctx.restore();
  }

  async function render(){
    clearErr();
    canDownload = true;

    const [W,H]=setCanvasSize();
    ctx.clearRect(0,0,W,H); // nền trong suốt

    const margin=Math.floor(Math.min(W,H)*0.06);
    const centerH=Math.floor(H*0.7);
    const playH=Math.min(centerH-margin, Math.floor(H*0.78));

    // Lấy nguồn ảnh: ưu tiên FILE (đọc bằng FileReader), sau đó URL
    const sources = await Promise.all([0,1,2].map(async i=>{
      const f = fileEls[i].files?.[0];
      if (f) {
        const dataURL = await readFileAsDataURL(f);
        return { type: "file", src: dataURL };
      }
      const u = (urlEls[i].value||"").trim();
      if (!u) throw new Error("Thiếu ảnh " + (i+1));
      return { type: "url", src: u };
    }));

    try{
      // Load hình
      const loaded = await Promise.all(sources.map(async s=>{
        if (s.type === "file"){
          return { img: await loadImage(s.src), corsOK: true };
        } else {
          const r = await loadURLWithCorsFallback(s.src);
          if (!r.corsOK) canDownload = false;
          return r;
        }
      }));

      // Sắp xếp
      const cIdx = parseInt(centerIdxEl.value,10)||1;
      const order = [0,1,2].filter(i=>i!==cIdx);
      const L = loaded[order[0]].img;
      const C = loaded[cIdx].img;
      const R = loaded[order[1]].img;

      // Kích thước
      const mainH=Math.floor(playH*0.92), sideH=Math.floor(playH*0.82);
      const Ls=sizeToHeight(L, sideH), Cs=sizeToHeight(C, mainH), Rs=sizeToHeight(R, sideH);

      // Layout
      const lt = (tiltEl.checked? -7:0);
      const rt = (tiltEl.checked? 7:0);
      const spacing=Math.floor(W*0.02);
      const totalW=Ls.w+Cs.w+Rs.w+2*spacing;
      const startX=Math.floor((W-totalW)/2);
      const yBase=Math.floor((H-Math.max(Ls.h,Cs.h,Rs.h))/2);

      const lx=startX, ly=yBase;
      const cx=lx+Ls.w+spacing, cy=yBase-Math.floor(H*0.02);
      const rx=cx+Cs.w+spacing, ry=yBase;

      // Bóng đổ
      if (shadowEl.checked){
        ctx.save(); ctx.translate(lx+Ls.w/2,ly+Ls.h/2); ctx.rotate(lt*Math.PI/180); ctx.translate(-Ls.w/2,-Ls.h/2); drawShadow(L,0,0,Ls.w,Ls.h,{blur:35,offsetY:25,scale:1.05,opacity:.75}); ctx.restore();
        drawShadow(C,cx,cy,Cs.w,Cs.h,{blur:40,offsetY:28,scale:1.06,opacity:.78});
        ctx.save(); ctx.translate(rx+Rs.w/2,ry+Rs.h/2); ctx.rotate(rt*Math.PI/180); ctx.translate(-Rs.w/2,-Rs.h/2); drawShadow(R,0,0,Rs.w,Rs.h,{blur:35,offsetY:25,scale:1.05,opacity:.75}); ctx.restore();
      }

      // Vẽ 3 ảnh
      drawWithTilt(L, lx, ly, lt, Ls.w, Ls.h);
      ctx.drawImage(C, cx, cy, Cs.w, Cs.h);
      drawWithTilt(R, rx, ry, rt, Rs.w, Rs.h);

      if (!canDownload){
        showErr("Ảnh URL bị chặn CORS: vẫn preview được, nhưng 'Tải PNG' sẽ không hoạt động. Hãy dùng 'Choose File' hoặc host ảnh trong cùng repo.");
      }

    }catch(e){
      showErr(e.message||String(e));
      console.error(e);
    }
  }

  document.getElementById("render").addEventListener("click", render);
  document.getElementById("download").addEventListener("click", ()=>{
    if (!canDownload){
      showErr("Không thể tải PNG vì nguồn ảnh chặn CORS. Dùng 'Choose File' hoặc ảnh cùng domain.");
      return;
    }
    const a=document.createElement("a"); a.href=cv.toDataURL("image/png");
    let fn=(nameEl.value||"playerpack").trim()||"playerpack";
    fn=fn.replace(/[/\\?%*:|"<>]+/g,"-"); a.download=fn+".png"; a.click();
  });

  // Render lần đầu (nếu URL hợp lệ)
  render();
})();
</script>
})();
</script>
</body>
</html>
